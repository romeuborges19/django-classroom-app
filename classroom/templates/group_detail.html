{% extends 'base/header.html' %}

{% load static %}
{% load widget_tweaks %}

{% block title %} Create Group of Classes {% endblock title %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'classroom/css/group_detail.css' %}">

<link rel="stylesheet" type="text/css" href="{% static 'classroom/css/styles.css' %}">
{% endblock extra_css %}

{% block content %}
<main>
	<div class="main-container">
		<div class="return-button-container-container">
			<div class="return-button-container-create">
				<a class="return-button" href="{% url 'classroom:groups' %}"> Voltar </a>
			</div>
		</div>
		<div class="group-info-container">
			<div class="group-title-container">
			<div class="email-success-message-container">
				{% if email_success %}
				<div class="email-success-message">
					{{ email_success }}
				</div>
				{% endif %}
			</div>
			<div class="email-error-message-container">
				{% if email_error %}
				<div class="email-error-message">
						<b>{{ email_error }}</b>
				</div>
				{% endif %}
			</div>
				<p> Grupo: <b>{{ group.name }}</b> </p>
				{% if num_students %}
					<p> {{ num_students }} estudantes matriculados </p>
				{% else %}
					<p> Nenhum estudante matriculado </p>
				{% endif %}

				{% if num_approved_list %}
					<p> Esperam-se {{ num_approved_list }} estudantes na turma. </p>
				{% endif %}

				<div class="group-info-input-container">
					<form method="POST" enctype="multipart/form-data">
						<button type="button" class="collapse-flex button-top-container">Definir lista de estudantes aprovados</button>
						<div class="approved-input-area-container">
							{% csrf_token %}
							

							{% for field in approved_form %}
								<div class="approved-input-container">
									{{ field }}

									<input class="approved-submit" type="submit" value="Definir">
								</div>
							{% endfor %}
							{% if form_error %}
								<div class="form-error-container">{{ form_error }} </div>
							{% endif %}

							<p class="helptext">Deve ser um arquivo .csv com colunas "fullname" e "email"</p>
						</div>
					</form>
					<button class="update-button button-top-container" data-update-url="{% url 'classroom:group' group.pk %}" data-group-id="{{ group.pk }}">Atualizar lista de estudantes matriculados</button>
					<p id="loading-message" class="loading-message"> Atualizando lista de estudantes matriculados. Aguarde... </p>
					<a href="{% url 'classroom:send_email' group.pk %}" class="link-button-container">Enviar e-mail para estudantes </a> 

					{% if approved_list %}
						<a href="{% url 'classroom:missing' group.pk %}" class="link-button-container">Gerenciar lista de estudantes ainda n√£o matriculados</a>
					{% endif %}
				</div>
				<div id="success-message" class="success-message">
					Lista de estudantes matriculados atualizada com sucesso
				</div>
			</div>
		


			<div class="group-classes-container">
				<p class="classes"> Classes: </p>
				{% for student_group in group.students %}
					<div class="class-info-container">
						<div class="class-title-container">
							<p> {{ student_group.0 }}</p>
						</div>
						<button type="button" class="collapse button-container">Ver lista de estudantes matriculados</button>
						<div class="class-students-container">
						{% for student in student_group.1 %}
							<div class="class-student-container">
								<p>{{ student.id }} - {{ student.fullname }} - {{ student.email }}</p>
							</div>
						{% endfor %}
						</div>
					</div>
				{% endfor %}
			</div>
		</div>
	</div>
</main>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'classroom/js/cookie.js' %}"></script>
<script>
$(document).ready(function() {
	setTimeout(() => {
		$(".email-success-message-container").slideUp("slow");
	}, 5000);

	setTimeout(() => {
		$(".email-error-message-container").slideUp("slow");
	}, 5000);

	$('.update-button').click(function() {
		$('#loading-message').slideDown("slow");
		const csrftoken = getCookie('csrftoken');
		const updateUrl = $(this).data('update-url');
		const groupId = $(this).data('group-id');
		$.ajax({
				url: updateUrl,
				method: 'POST',
				headers: {'X-CSRFToken': csrftoken},
				data: {'group_id': groupId},
				mode: 'same-origin',
				success: function(response) {
					if (response.error) {
						alert(response.error);
					} else {
						$('#success-message').fadeIn("fast");
						$('#loading-message').hide();
						setTimeout(() => {
							$('#success-message').slideUp("slow");
					    }, 5000);	
						location.reload()
					}
				}
			})
		})
	})


var coll = document.getElementsByClassName("collapse");
var i;

for (i = 0; i < coll.length; i++) {
	coll[i].addEventListener("click", function () {
		this.classList.toggle("active");
		var content = this.nextElementSibling;

		if (content.style.display === "block") {
			coll.value = "Close student list";
			content.style.display = "none";
		} else {
			content.style.display = "block";
		}
	})
}

var coll = document.getElementsByClassName("collapse-flex");
var i;

for (i = 0; i < coll.length; i++) {
	coll[i].addEventListener("click", function () {
		this.classList.toggle("active");
		var content = this.nextElementSibling;

		if (content.style.display === "flex") {
			coll.value = "Close student list";
			content.style.display = "none";
		} else {
			content.style.display = "flex";
		}
	})
}
</script>
{% endblock content %}
